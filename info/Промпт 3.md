**Objective:** Implement the "Role" personalization system, time-based memory management for "Hooks", and handlers for user commands: /clean, /hooks, and /role. This requires database model updates, enhancements to the Gemini service, and state management (FSM) for interactive commands.

**Instructions:**

**1. Database Model Updates (app/database/models.py)**  
* **User Model:** Add a new nullable column role_prompt (Text type) to store the user's global role.  
* **Hook Model:** Add a new nullable column expires_at (TIMESTAMP with timezone=True) to specify when a hook should expire. Ensure all necessary SQLAlchemy and datetime imports are present.

**2. Gemini Service Enhancements (app/services/gemini_service.py)**  
* **Tool Definition (MANAGE_HOOKS_TOOL):**  
* Modify the hooks_to_add and hooks_to_update schemas within the manage_user_memory_hooks function declaration.  
* For items in hooks_to_add and hooks_to_update, add an optional parameter expires_at (string, format date-time, e.g., 'YYYY-MM-DDTHH:MM:SSZ').  
* The prompt for Gemini should encourage it to infer and suggest an expires_at value for temporary facts (e.g., "еду в отпуск на неделю" -> expires_at in 7 days).  
* **analyze_and_manage_hooks Function:**  
* Update its signature to accept chat_session (an instance of genai.GenerativeModel.start_chat) and role_prompt (string or None).  
* Integrate the role_prompt at the beginning of the system instructions provided to Gemini.  
* Crucially, instead of model.generate_content_async, use chat_session.send_message_async to maintain conversational history with Gemini.  
* Ensure the function correctly handles FunctionCall results, specifically parsing the expires_at string from Gemini into a timezone-aware datetime object for database storage.

**3. Implement Command Handlers (app/handlers/user_commands.py)**  
* **Dependency Management:** Handlers will receive AsyncSession, user_chat_sessions (a dictionary for storing ChatSession objects per user_id), and gemini_model (the initialized GenerativeModel instance) via dispatcher workflow data. Ensure correct type hints for dependency injection.  
* **General Message Handler (@router.message(F.text & ~F.text.startswith('/'))):**  
* Retrieve the user and their associated hooks from the database (including selectinload(User.hooks)).  
* Filter out any expired hooks based on expires_at before passing them to the Gemini service.  
* For the current user, retrieve or initialize their chat_session from user_chat_sessions.  
* Call the analyze_and_manage_hooks function, passing the chat_session, user message, filtered existing hook texts, and user.role_prompt.  
* Process the FunctionCall returned by Gemini:  
* Add new Hook objects (parsing expires_at string to datetime).  
* Update existing Hook objects (parsing expires_at string to datetime).  
* Delete Hook objects.  
* Commit all changes to the database.  
* This handler should not send any response message to the user.  
* **/clean Command Handler:**  
* Upon command, clear or re-initialize the chat_session for the specific user in the user_chat_sessions dictionary.  
* Send a confirmation message to the user indicating the chat history has been cleared.  
* **/hooks Command Handler:**  
* Retrieve all non-expired hooks for the user from the database.  
* Format and send a list of these hooks to the user. Include the expiration date if expires_at is set for a hook.  
* Inform the user that editing/deleting hooks is done via natural language interaction.  
* **/role Command Handler:**  
* Upon command, display the user's current role_prompt.  
* Provide an InlineKeyboardMarkup with two buttons: "Очистить роль" (Clear Role) and "Изменить роль" (Edit Role).  
* **Callback Handler for "Clear Role":**  
* Set user.role_prompt to None.  
* Commit changes.  
* Edit the original message to confirm the role has been cleared and remove buttons.  
* **Callback Handler for "Edit Role":**  
* Set the FSM state for the user (define a StatesGroup for role management).  
* Prompt the user to enter their new role.  
* Edit the original message to remove buttons.  
* **Message Handler for FSM State (waiting_for_new_role):**  
* Update user.role_prompt with the received message text.  
* Commit changes.  
* Clear the FSM state.  
* Send a confirmation message.

**4. Main Bot File Updates (app/bot.py)**  
* **FSM Storage:** Initialize MemoryStorage and pass it to the Dispatcher.  
* **Workflow Data:** Add user_chat_sessions (an empty dictionary initialized at bot start) and the pre-initialized gemini_model instance from gemini_service to dp.workflow_data. This makes these objects available to all handlers via dependency injection.  
* Ensure create_tables() from app.database.engine is called at bot startup to create all necessary database tables (including the updated users and new hooks table).